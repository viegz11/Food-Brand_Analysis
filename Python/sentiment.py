import pandas as pd
import numpy as np
from textblob import TextBlob
from nrclex import NRCLex

# ================= CONFIG =================
INPUT_FILE = "merged_sd.xlsx"          # Your input Excel file
OUTPUT_FILE = "survey_sentiment.xlsx"

TEXT_COLUMNS = [
    "Food Preference",
    "Key Expectation",
    "Nutritional Claim",
    "Recommendation",
    "Primary Purchase Motivation",
    "Calories",
    "Price Perception",
    "Feedback Comments"
]

RATING_COLUMNS = [
    "Packaging/Service Quality",
    "Taste Rating",
    "Food Quality Rating",
    "Overall Feedback Rating"
]
# ==========================================


# ---------- Helper Functions ----------

def combine_text(df, cols):
    cols = [c for c in cols if c in df.columns]
    return df[cols].fillna("").astype(str).agg(" ".join, axis=1)


def text_sentiment(text):
    if not text.strip():
        return 0.0, 0.0
    s = TextBlob(text).sentiment
    return s.polarity, s.subjectivity


def polarity_label(p):
    if p > 0.05:
        return "Positive"
    elif p < -0.05:
        return "Negative"
    return "Neutral"


def rating_to_score(r):
    # Convert 1â€“5 scale to -1 to +1
    return (r - 3) / 2


def emotion_category(text):
    if not text.strip():
        return "Neutral"
    emotion = NRCLex(text).top_emotions
    return emotion[0][0].capitalize() if emotion else "Neutral"


# ---------- Main Pipeline ----------

def main():
    print("ðŸ“¥ Reading Excel file...")
    df = pd.read_excel(INPUT_FILE)

    # Combine text columns
    print("ðŸ§© Combining text columns...")
    df["combined_text"] = combine_text(df, TEXT_COLUMNS)

    # Text sentiment
    print("ðŸ§  Computing polarity & subjectivity...")
    sentiment_vals = df["combined_text"].apply(text_sentiment)
    df["polarity_score"] = sentiment_vals.apply(lambda x: x[0])
    df["subjectivity"] = sentiment_vals.apply(lambda x: x[1])
    df["text_sentiment"] = df["polarity_score"].apply(polarity_label)

    # Rating sentiment
    print("â­ Processing rating sentiment...")
    valid_ratings = [c for c in RATING_COLUMNS if c in df.columns]
    df["avg_rating"] = df[valid_ratings].mean(axis=1)

    df["rating_sentiment_score"] = df["avg_rating"].apply(rating_to_score).clip(-1, 1)
    df["rating_sentiment_label"] = df["rating_sentiment_score"].apply(polarity_label)

    # Final sentiment score (text + rating)
    print("ðŸ”— Combining text & rating sentiment...")
    df["sentiment_score"] = (
        df["polarity_score"] * 0.5 +
        df["rating_sentiment_score"] * 0.5
    )

    df["sentiment_label"] = df["sentiment_score"].apply(polarity_label)

    # Emotion detection
    print("ðŸ˜Š Detecting emotion category...")
    df["emotion_category"] = df["combined_text"].apply(emotion_category)

    # Save output
    print("ðŸ’¾ Saving output Excel file...")
    df.to_excel(OUTPUT_FILE, index=False)

    print("âœ… Sentiment analysis completed successfully!")


if __name__ == "__main__":
    main()










































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































